<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Viewer (Fix Edition)</title>
<style>
 body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:16px;max-width:980px}
 h1{margin:0 0 8px}
 .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
 .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin:8px 0}
 video{width:100%;background:#000;border-radius:8px}
 textarea{width:100%;min-height:140px;font-family:ui-monospace,Consolas,monospace}
 button{padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:#f6f6f6;cursor:pointer}
 .mono{font-family:ui-monospace,Consolas,monospace}
 .warn{color:#9a6700}
</style>
</head>
<body>
<h1>Viewer</h1>
<p class="warn" id="httpsWarn" style="display:none">Open over <b>HTTPS</b> for best compatibility.</p>
<div class="card">
  <video id="remote" autoplay playsinline controls muted></video>
  <p>Status: <span id="st" class="mono">idle</span></p>
  <div class="row">
    <button id="answer">Create Answer</button>
    <button id="copy" disabled>Copy Answer</button>
    <button id="stop" disabled>Stop</button>
  </div>
</div>
<div class="card">
  <label>Offer (paste from camera)</label>
  <textarea id="offerIn" placeholder="Paste the Offer JSON"></textarea>
  <label>Answer (copy this back to camera)</label>
  <textarea id="answerOut" placeholder="Click 'Create Answer'"></textarea>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const httpsWarn = document.getElementById('httpsWarn');
  if(location.protocol!=='https:' && location.hostname!=='localhost'){ httpsWarn.style.display='block'; }

  const remote = document.getElementById('remote');
  const st = document.getElementById('st');
  const btnAns = document.getElementById('answer');
  const btnCopy = document.getElementById('copy');
  const btnStop = document.getElementById('stop');
  const offerIn = document.getElementById('offerIn');
  const answerOut = document.getElementById('answerOut');

  let pc=null, remoteStream=null;

  function setStatus(s){ st.textContent=s; }
  function iceServers(){ return [{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]; }
  async function waitIce(pc){ if(pc.iceGatheringState==='complete') return; await new Promise(res=>{const f=()=>{if(pc.iceGatheringState==='complete'){pc.removeEventListener('icegatheringstatechange',f);res();}}; pc.addEventListener('icegatheringstatechange',f);}); }

  btnAns.onclick = async () => {
    try{
      const text=offerIn.value.trim(); if(!text) return alert('Paste the Offer first.');
      const offer=JSON.parse(text);
      pc = new RTCPeerConnection({iceServers: iceServers()});
      remoteStream=new MediaStream(); remote.srcObject=remoteStream;
      pc.ontrack = (e)=>{ e.streams[0].getTracks().forEach(t=>remoteStream.addTrack(t)); };
      setStatus('applying offer...'); await pc.setRemoteDescription(offer);
      setStatus('creating answer...'); const ans=await pc.createAnswer(); await pc.setLocalDescription(ans);
      setStatus('gathering ICE...'); await waitIce(pc);
      answerOut.value = JSON.stringify(pc.localDescription);
      btnCopy.disabled=false; btnStop.disabled=false; setStatus('answer ready — copy to camera');
    }catch(e){ setStatus('error: '+e.message); }
  };

  btnCopy.onclick = async () => {
    try{ await navigator.clipboard.writeText(answerOut.value); setStatus('answer copied'); }
    catch{ setStatus('copy failed — select and copy'); }
  };

  btnStop.onclick = () => {
    try{ if(pc){ pc.close(); pc=null; } if(remoteStream){ remoteStream.getTracks().forEach(t=>t.stop()); remoteStream=null; } setStatus('stopped'); }
    catch(e){ setStatus('stop error: '+e.message); }
  };
});
</script>
</body>
</html>
